// Generated by CoffeeScript 2.3.2

// MAP

// Leaflet MAP
window.fn.sensors = {
  "1002": {
    name: 'Миладиновци'
  },
  "11888f3a-bc5e-4a0c-9f27-702984decedf": {
    name: 'МЗТ'
  },
  "01440b05-255d-4764-be87-bdf135f32289": {
    name: 'Бардовци'
  },
  "bb948861-3fd7-47dd-b986-cb13c9732725": {
    name: 'Бисер'
  },
  "cec29ba1-5414-4cf3-bbcc-8ce4db1da5d0": {
    name: 'Алуминка'
  },
  "1005": {
    name: 'Ректорат'
  },
  "bc9f31ea-bf3d-416c-86b5-ecba6e98bb24": {
    name: 'Фонтана'
  },
  "66710fdc-cdfc-4bbe-93a8-7e796fb8a88d": {
    name: 'Козле'
  },
  "24eaebc2-ca62-49ff-8b22-880bc131b69f": {
    name: 'Црниче'
  },
  "b79604bb-0bea-454f-a474-849156e418ea": {
    name: 'Драчево'
  },
  "1004": {
    name: 'Газибаба'
  },
  "fc4bfa77-f791-4f93-8c0c-62d8306c599c": {
    name: 'Нерези'
  },
  "cfb0a034-6e29-4803-be02-9215dcac17a8": {
    name: 'Ѓорче Петров'
  },
  "1003": {
    name: 'Карпош'
  },
  "200cdb67-8dc5-4dcf-ac62-748db636e04e": {
    name: '11ти Октомври'
  },
  "8d415fa0-77dc-4cb3-8460-a9159800917f": {
    name: 'СД Гоце Делчев'
  },
  "b80e5cd2-76cb-40bf-b784-2a0a312e6264": {
    name: 'Станица Ѓорче'
  },
  "6380c7cc-df23-4512-ad10-f2b363000579": {
    name: 'Сопиште'
  },
  "eaae3b5f-bd71-46f9-85d5-8d3a19c96322": {
    name: 'Карпош 2'
  },
  "7c497bfd-36b6-4eed-9172-37fd70f17c48": {
    name: 'Железара'
  },
  "1000": {
    name: 'Центар'
  },
  "3d7bd712-24a9-482c-b387-a8168b12d3f4": {
    name: 'Бутел 1'
  },
  "5f718e32-5491-4c3c-98ff-45dc9e287df4": {
    name: 'Водно'
  },
  "e7a05c01-1d5c-479a-a5a5-419f28cebeef": {
    name: 'Излет'
  },
  "1001": {
    name: 'Лисиче'
  },
  "8ad9e315-0e23-4dc0-a26f-ba5a17d4d7ed": {
    name: 'Аеродром'
  },
  "680b0098-7c4d-44cf-acb1-dc4031e93d34": {
    name: 'Илинден'
  }
};

window.fn.loadSensors = function() {
  var content, menu;
  content = $('#content')[0];
  menu = $('#menu')[0];
  return content.load('views/sensors.html').then(menu.close.bind(menu)).then(function() {
    var CENTER, CITY, PASSWORD, USERNAME, getSensors, map, parsePos, renderMap, sensors;
    
    // MAP

    // Leaflet MAP
    map = null;
    CENTER = [41.99249998, 21.42361109];
    CITY = 'skopje';
    USERNAME = "atonevski";
    PASSWORD = "pv1530kay";
    sensors = [];
    parsePos = function(s) {
      return s.split(/\s*,\s*/).map(function(v) {
        return parseFloat(v);
      });
    };
    getSensors = function() {
      return $.ajax({
        url: `https://${CITY}.pulse.eco/rest/sensor`,
        method: 'GET',
        username: USERNAME,
        password: PASSWORD
      }).done(function(d) {
        var i, id, len, marker, pos, ref, results, s;
// console.log d
        for (i = 0, len = d.length; i < len; i++) {
          s = d[i];
          if (window.fn.sensors[s.sensorId] != null) {
            window.fn.sensors[s.sensorId].position = s.position;
            window.fn.sensors[s.sensorId].description = s.description;
            window.fn.sensors[s.sensorId].coments = s.coments;
          } else {
            window.fn.sensors[s.sensorId] = s;
            window.fn.sensors[s.sensorId].name = s.description;
          }
        }
        console.log(window.fn.sensors);
        sensors = d;
        ref = window.fn.sensors;
        results = [];
        for (id in ref) {
          s = ref[id];
          pos = parsePos(s.position);
          results.push(marker = L.marker(pos).addTo(map).bindPopup(`<p>Sensor: ${s.name}</p>`));
        }
        return results;
      });
    };
    renderMap = function() {
      map = L.map('map-id').setView(CENTER, 12);
      // L.tileLayer 'http://{s}.tile.osm.org/{z}/{x}/{y}.png', {}
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {}).addTo(map);
      console.log(`base64: ${btoa('abc')}`);
      return getSensors();
    };
    return renderMap();
  });
};

// map = null
// CENTER = [ 41.99249998, 21.42361109 ]
// CITY = 'skopje'
// USERNAME = "atonevski"
// PASSWORD = "pv1530kay"
// sensors = []

// parsePos = (s) ->
//   s.split /\s*,\s*/
//     .map (v) -> parseFloat(v)

// getSensors = () ->
//   $.ajax
//     url: "https://#{ CITY }.pulse.eco/rest/sensor"
//     method: 'GET'
//     username: USERNAME
//     password: PASSWORD
//   .done (d) ->
//     console.log d
//     sensors = d
//     for s in sensors
//       pos = parsePos s.position
//       marker = L.marker pos
//         .addTo map
//         .bindPopup "<p>Sensor: #{ s.description }</p>"

// renderMap = () ->
//   map = L.map 'map-id'
//          .setView CENTER, 12

//   L.tileLayer 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { }
//   # L.tileLayer 'http://{s}.tile.osm.org/{z}/{x}/{y}.png', {}
//   .addTo @map

//   console.log "base64: #{ btoa 'abc' }"
//   getSensors()

// renderMap()
