// Generated by CoffeeScript 2.3.2
window.fn = {};

window.fn.open = function() {
  var menu;
  menu = $('#menu')[0];
  return menu.open();
};

window.fn.load = function(page) {
  var content, menu;
  content = $('#content')[0];
  menu = $('#menu')[0];
  return content.load(page).then(menu.close.bind(menu));
};

window.fn.loadSensors = function() {
  var content, menu;
  content = $('#content')[0];
  menu = $('#menu')[0];
  return content.load('views/sensors.html').then(menu.close.bind(menu)).then(function() {
    var CENTER, CITY, PASSWORD, USERNAME, getSensors, map, parsePos, renderMap, sensors;
    
    // MAP

    // Leaflet MAP
    map = null;
    CENTER = [41.99249998, 21.42361109];
    CITY = 'skopje';
    USERNAME = "atonevski";
    PASSWORD = "pv1530kay";
    sensors = [];
    parsePos = function(s) {
      return s.split(/\s*,\s*/).map(function(v) {
        return parseFloat(v);
      });
    };
    getSensors = function() {
      return $.ajax({
        url: `https://${CITY}.pulse.eco/rest/sensor`,
        method: 'GET',
        username: USERNAME,
        password: PASSWORD
      }).done(function(d) {
        var i, len, marker, pos, results, s;
        console.log(d);
        sensors = d;
        results = [];
        for (i = 0, len = sensors.length; i < len; i++) {
          s = sensors[i];
          pos = parsePos(s.position);
          results.push(marker = L.marker(pos).addTo(map).bindPopup(`<p>Sensor: ${s.description}</p>`));
        }
        return results;
      });
    };
    renderMap = function() {
      map = L.map('map-id').setView(CENTER, 12);
      // L.tileLayer 'http://{s}.tile.osm.org/{z}/{x}/{y}.png', {}
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {}).addTo(map);
      console.log(`base64: ${btoa('abc')}`);
      return getSensors();
    };
    return renderMap();
  });
};

// # 1st experimental code
// # - maps
// # - get sensors
// # - some formatting
// # - etc.
// #
// showAlert = (m) ->
//   ons.notification.alert m

// showToast = (m) ->
//   t = 2000
//   t = arguments[1] if arguments.length > 1
//   ons.notification.toast m, timeout: t

// # formats Date to "YYYY-mm-ddTHH:MM:SS[+|-]HH:MM"
// toDTM = (d) ->
//   throw "#{ d } is not Date()" unless d instanceof Date
//   dd = (new Date(d - d.getTimezoneOffset()*1000*60))
//   ymd= dd.toISOString()[0..9]
//   re = /(\d\d:\d\d:\d\d) GMT([-+]\d+)/gm
//   s = re.exec d.toString()
//   "#{ ymd }T#{ s[1] }#{ s[2][0..2] }:#{ s[2][3..4] }"

// #
// # MAP
// #
// # Leaflet MAP
// map = null
// CENTER = [ 41.99249998, 21.42361109 ]
// CITY = 'skopje'
// USERNAME = "atonevski"
// PASSWORD = "pv1530kay" 
// sensors = []

// parsePos = (s) ->
//   s.split /\s*,\s*/
//     .map (v) -> parseFloat(v)

// getSensors = () ->
//   $.ajax
//     url: "https://#{ CITY }.pulse.eco/rest/sensor"
//     method: 'GET'
//     username: USERNAME
//     password: PASSWORD
//   .done (d) ->
//     console.log d
//     sensors = d
//     for s in sensors
//       pos = parsePos s.position
//       marker = L.marker pos
//         .addTo map
//         .bindPopup "<p>Sensor: #{ s.description }</p>"

// renderMap = () ->
//   map = L.map 'map-id'
//          .setView CENTER, 12

//   L.tileLayer 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { }
//   # L.tileLayer 'http://{s}.tile.osm.org/{z}/{x}/{y}.png', {}
//   .addTo map

//   console.log "base64: #{ btoa 'abc' }"
//   getSensors()
// renderMap()
