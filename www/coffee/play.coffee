#
# play.coffee: play last 24h pm10 measurements
#

window.fn.playMap = null

# add group property
window.fn.playSensors =
  "1002": { name: 'Миладиновци', group: 13 }
  "11888f3a-bc5e-4a0c-9f27-702984decedf": { name: 'МЗТ', group: 9 }
  "01440b05-255d-4764-be87-bdf135f32289": { name: 'Бардовци', group: 10 }
  "bb948861-3fd7-47dd-b986-cb13c9732725": { name: 'Бисер', group: 7 }
  "cec29ba1-5414-4cf3-bbcc-8ce4db1da5d0": { name: 'Алуминка', group: 1 }
  "1005": { name: 'Ректорат', group: 3 }
  "bc9f31ea-bf3d-416c-86b5-ecba6e98bb24": { name: 'Фонтана', group: 3 }
  "66710fdc-cdfc-4bbe-93a8-7e796fb8a88d": { name: 'Козле', group: 2 }
  "24eaebc2-ca62-49ff-8b22-880bc131b69f": { name: 'Црниче', group: 5 }
  "b79604bb-0bea-454f-a474-849156e418ea": { name: 'Драчево', group: 11 }
  "1004": { name: 'Газибаба', group: 8 }
  "fc4bfa77-f791-4f93-8c0c-62d8306c599c": { name: 'Нерези', group: 2 }
  "cfb0a034-6e29-4803-be02-9215dcac17a8": { name: 'Ѓорче Петров', group: 4 }
  "1003": { name: 'Карпош', group: 1 }
  "200cdb67-8dc5-4dcf-ac62-748db636e04e": { name: '11ти Октомври', group: 6 }
  "8d415fa0-77dc-4cb3-8460-a9159800917f": { name: 'СД Гоце Делчев', group: 2 }
  "b80e5cd2-76cb-40bf-b784-2a0a312e6264": { name: 'Станица Ѓорче', group: 4 }
  "6380c7cc-df23-4512-ad10-f2b363000579": { name: 'Сопиште', group: 6 }
  "eaae3b5f-bd71-46f9-85d5-8d3a19c96322": { name: 'Карпош 2', group: 1 }
  "7c497bfd-36b6-4eed-9172-37fd70f17c48": { name: 'Железара', group: 8 }
  "1000": { name: 'Центар', group: 3 }
  "3d7bd712-24a9-482c-b387-a8168b12d3f4": { name: 'Бутел 1', group: 0 }
  "5f718e32-5491-4c3c-98ff-45dc9e287df4": { name: 'Водно', group: 5 }
  "e7a05c01-1d5c-479a-a5a5-419f28cebeef": { name: 'Излет', group: 3 }
  "1001": { name: 'Лисиче', group: 7 }
  "8ad9e315-0e23-4dc0-a26f-ba5a17d4d7ed": { name: 'Аеродром', group: 7}
  "680b0098-7c4d-44cf-acb1-dc4031e93d34": { name: 'Илинден', group: 12}

# latlngs for group/area
latlngs = [
  [ #0: Бутел
    [42.02085304335116, 21.449068749034254],
    [42.0222566295136, 21.43018848436059],
    [42.02723273079618, 21.429244471126886],
    [42.02710514332077, 21.434393634219713],
    [42.052352164029465, 21.423005104261396],
    [42.04594384579999, 21.43919259561023],
    [42.0397833869608, 21.454604110248848],
  ],
  [ #1: Карпош
    [42.00014153064202, 21.41316319319767],
    [42.00460390831076, 21.38278313095],
    [42.00557239019032, 21.380225335657713],
    [42.00966193219604, 21.38228917108791],
    [42.00930271511426, 21.38507317670075],
    [42.00767729097137, 21.39090889487261],
    [42.00767729097137, 21.39082307548773],
    [42.006179314301946, 21.414080128790324],
    [42.0053187585617, 21.416654710336722],
    [42.0016532981841, 21.41347939309618],
  ],
  [ #2: Тафталиџе
    [41.999901217245906, 21.413094422668596],
    [41.993366432064164, 21.411034757431477],
    [41.989190193553455, 21.406228871878163],
    [41.99748501915229, 21.371961189924015],
    [42.00523402234377, 21.38009756173427],
    [42.00445313657715, 21.382779417511763],
  ],
  [ #3: Центар
    [41.98745837139266, 21.441801552158026],
    [41.98758589765055, 21.431760684127],
    [41.99153908493555, 21.42352202317851],
    [41.98758589765055, 21.417171388697337],
    [41.99309313129358, 21.411201094635402],
    [41.99978732184316, 21.413260759872532],
    [42.00153873372848, 21.41366539376736],
    [42.00518184740425, 21.416814956452857],
    [42.002058244270216, 21.423101226395328],
    [42.00358819149654, 21.42438851716855],
    [42.0011892397794, 21.428743322597725],
    [41.99854358309758, 21.450155259125392],
    [41.99385763206613, 21.448567600505104],
  ],
  [ #4: Ѓорче Петров
    [42.0104374739155, 21.381418140250933],
    [42.005146819652325, 21.379229745936488],
    [41.99787942070697, 21.371506001297263],
    [42.00227820869816, 21.34760530260808],
    [42.00686792414399, 21.331814535790077],
    [42.00906704545891, 21.32966905116807],
    [42.01126609075234, 21.358590183872767],
    [42.011680395122966, 21.379358475013806],
  ],
  [ #5: Водно
    [41.98734784287371, 21.431993218498246],
    [41.98285237126461, 21.434996896969064],
    [41.982055268700734, 21.43482525819931],
    [41.975614312962584, 21.43832668805481],
    [41.971937733549375, 21.436502948400076],
    [41.97538248984099, 21.43135310676406],
    [41.98153793295743, 21.42189456450104],
    [41.98563607904012, 21.41173553492991],
    [41.98914706834681, 21.40632390975952],
    [41.993148836140286, 21.410950183835673],
    [41.98757415545117, 21.417117118917304],
    [41.99148042888061, 21.423517942084803],
  ],
  [ #6: Кисела Вода
    [41.987405225853784, 21.432231903272626],
    [41.98281304317566, 21.435235977369306],
    [41.98199980963907, 21.434957027631757],
    [41.97562578450093, 21.438362360131578],
    [41.97173954577081, 21.436504125595093],
    [41.968428076659336, 21.44695185536242],
    [41.96385194392173, 21.43320861490372],
    [41.95589477301708, 21.43069553643727],
    [41.95602239300942, 21.44388771430386],
    [41.95988274753732, 21.45131206885708],
    [41.974680134569695, 21.461491584777836],
    [41.976389270759356, 21.45737171189467],
    [41.97611178885931, 21.45797681851036],
    [41.982805039080375, 21.443595886230472],
    [41.98428796731331, 21.441763399361665],
    [41.98487794010307, 21.441312788247163],
    [41.98578202601866, 21.440956592559814],
    [41.98653143238881, 21.441063880920414],
    [41.98743951388864, 21.441814899444584],
  ],
  [ #7: Аеродром
    [41.96521321351477, 21.491369248615232],
    [41.96401125335132, 21.486622810953126],
    [41.974780392600195, 21.462706089641873],
    [41.97635531282277, 21.458144187927246],
    [41.97635531282277, 21.458144187927246],
    [41.98326756292444, 21.44337272542544],
    [41.98441563145085, 21.441977976737697],
    [41.985133163767294, 21.441527365623195],
    [41.98597824701364, 21.441377161918354],
    [41.98671170639861, 21.441591738639552],
    [41.98728571219694, 21.442042349754054],
    [41.99408330330143, 21.449588420157912],
    [41.990111145672934, 21.455437010713727],
    [41.99168919937105, 21.460800722268754],
    [41.994159810929126, 21.464726959127027],
    [41.99039806743705, 21.473845268770564],
    [41.99027625458941, 21.473972546095684],
    [41.98957488665183, 21.48100973565588],
    [41.98415496474574, 21.49122224245667],
    [41.98262455031965, 21.495427392315793],
    [41.980647710575276, 21.49843107078658],
    [41.97822440393778, 21.498860167711012],
    [41.97643875056391, 21.50057655540862],
    [41.97580100508219, 21.501520568642285],
  ],
  [ #8: Автокоманда+Железара+Ченто
    [41.99702382087668, 21.529375076424913],
    [41.998991954254535, 21.50402069091797],
    [42.00480282872743, 21.48002243120573],
    [41.99967233494524, 21.451646805398926],
    [42.00205545105743, 21.451719761189455],
    [42.00305971566881, 21.456118584301297],
    [42.007162689160154, 21.459242821165393],
    [42.009349559108614, 21.45964193350665],
    [42.0140003919269, 21.454208850991566],
    [42.01585315628746, 21.45219612226356],
    [42.02093820121273, 21.4492263799184],
    [42.02694264184265, 21.451415062474553],
    [42.0396144965093, 21.45532036403893],
    [42.03132961764397, 21.497755055897873],
    [42.02971932393803, 21.52050020406023],
    [42.012890897084645, 21.532173177693043],
    [41.99702382087668, 21.529375076424913],
  ],
  [ #9: Маџари+Хиподром
    [41.993313990077745, 21.530027389526367],
    [41.99618366965164, 21.52153015136719],
    [41.99657903641696, 21.516311646555554],
    [41.99766309718109, 21.50541114911903],
    [41.99854604953885, 21.502647399902344],
    [42.003634440127776, 21.481962203979492],
    [42.0021423941035, 21.471473694109598],
    [41.999006394403686, 21.45128631595071],
    [41.995240878873986, 21.44975852976131],
    [41.993200200904845, 21.45171117792416],
    [41.991599497945295, 21.454226016867327],
    [41.99091392576721, 21.456972598898577],
    [41.99163138484365, 21.45881795870082],
    [41.99376777064399, 21.460843563063467],
    [41.99467651002937, 21.462560176832998],
    [41.995001740795495, 21.465495586280674],
    [41.994268376926605, 21.468070506934964],
    [41.99324803053007, 21.469937324409337],
    [41.983524961557634, 21.498973840934926],
    [41.97803948170846, 21.501548761589223],
    [41.985918729384345, 21.510715484619144],
  ],
  [ #10: Бардовци
    [42.00900286039821, 21.324119409620764],
    [42.00941717950984, 21.329697669637987],
    [42.011313451772914, 21.345295342839975],
    [42.011303890780816, 21.34785705200245],
    [42.010905518885565, 21.352319660016256],
    [42.01117641204577, 21.356524809875378],
    [42.011636098529756, 21.379680114407083],
    [42.0132506280016, 21.41325993392542],
    [42.01949658186978, 21.4099987973],
    [42.02459486494895, 21.412058462537118],
    [42.0222350748204, 21.429911501241865],
    [42.02716745778609, 21.42905759993369],
    [42.02718338863532, 21.434249672718952],
    [42.05223658652196, 21.422873554133805],
    [42.05260899088653, 21.381681236491644],
    [42.0525771424161, 21.3656501734972],
    [42.05471098718492, 21.356467499315002],
    [42.056080432121995, 21.347915597808093],
    [42.05510908486005, 21.343646083410306],
    [42.05186053691804, 21.33944093355118],
    [42.04565598531368, 21.338149352856306],
    [42.03829446127371, 21.336849188389657],
    [42.02988388773591, 21.33069593810092],
    [42.017852283885176, 21.331820171911886],
    [42.0134545726861, 21.33038269721513],
    [42.01096877532139, 21.32757211236032],
    [42.01028038378219, 21.326297694298397],
  ],
  [ #11: Драчево
    [41.948416545200615, 21.511551093055237],
    [41.94044102604154, 21.5409871420692],
    [41.9360381121176, 21.5409871420692],
    [41.93361318913743, 21.534636507588026],
    [41.9299118131517, 21.535237243282214],
    [41.92589110967575, 21.52965898326499],
    [41.92461464288131, 21.512752564443527],
    [41.93265595731823, 21.516013701068992],
    [41.935017103152745, 21.508118317660006],
    [41.935591422706715, 21.501939321948598],
    [41.940951489149725, 21.504428084110156],
  ],
  [ #12: Илинден
    [41.99817833451146, 21.548629735708737],
    [42.001238277097144, 21.560644449592008],
    [42.00187574661528, 21.57695013271929],
    [41.998815834684244, 21.59634531370227],
    [41.99422569089769, 21.598233340169635],
    [41.98887010472021, 21.605270529729832],
    [41.97815758056011, 21.6071585561972],
    [41.97356594703401, 21.60630036234837],
    [41.97088734126831, 21.582614212121385],
    [41.982748883042774, 21.57849488164714],
    [41.98784994197814, 21.56991294315909],
    [41.98938017996059, 21.562017559750107],
    [41.99142044005076, 21.550346123406353],
  ],
  [ #13: Миладиновци
    [41.98923749037232, 21.647618456865054],
    [41.99185156769003, 21.652510161803207],
    [41.99204283742523, 21.655513840274036],
    [41.990831452728585, 21.657144408586763],
    [41.98770724895983, 21.656629492277496],
    [41.98464665578334, 21.655256382119397],
    [41.98190474945355, 21.654569827040326],
    [41.97814240675479, 21.653110897497392],
    [41.97546399345698, 21.6517377873393],
    [41.97284924324992, 21.65002139964169],
    [41.9726579158494, 21.647532637480175],
    [41.9726579158494, 21.64349912639076],
    [41.973933420996886, 21.639980531610664],
    [41.977122072114376, 21.63972307345603],
    [41.9798004156786, 21.642297655002462],
    [41.98133084713901, 21.645387152858127],
    [41.98420030698533, 21.648219192559196],
  ]
]

polys = []

window.fn.loadPlay = () ->
  content = $('#content')[0]
  menu = $('#menu')[0]

  if window.fn.selected is 'measurements'
    menu.close.bind(menu)()
    return

  content.load 'views/play.html'
         .then menu.close.bind(menu)
         .then () ->
           renderPlay()

data = null
stamps = []

#
renderPlay = () ->
  window.fn.selected = 'measurements'

  CENTER = [ 41.99249998, 21.42361109 ]
  CITY = 'skopje'
  USERNAME = "atonevski"
  PASSWORD = "pv1530kay"


  parsePos = (s) ->
    s.split /\s*,\s*/
      .map (v) -> parseFloat(v)

  toDTM = (d) ->
    throw "#{ d } is not Date()" unless d instanceof Date
    dd = (new Date(d - d.getTimezoneOffset()*1000*60))
    ymd= dd.toISOString()[0..9]
    re = /(\d\d:\d\d:\d\d) GMT([-+]\d+)/gm
    s = re.exec d.toString()
    "#{ ymd }T#{ s[1] }#{ s[2][0..2] }:#{ s[2][3..4] }"

  # get last 24h measurements but only for pm10
  getLast24h = () ->
    #...
    to = new Date()
    from = new Date to - 24*60*60*1000
    url = "https://#{ CITY }.pulse.eco/rest/dataRaw?" +
          "type=pm10&" +
          "from=#{ encodeURIComponent toDTM(from) }&" +
          "to=#{ encodeURIComponent toDTM(to) }"
    $.ajax
      url: url
      method: 'GET'
      username: USERNAME
      password: PASSWORD
      dataType: "json"
      headers:
        "Authorization": "Basic " + btoa(USERNAME + ":" + PASSWORD)
    .done (d) =>
      data = d
      stamps = data
                .map (x) -> x.stamp[0..12]
                .filter (v, i, self) -> self.indexOf(v) is i
      console.log 'stamps:', stamps

      # for every stamp, for every group calc avg typeVal...

  getSensors = () ->
    $.ajax
      url: "https://#{ CITY }.pulse.eco/rest/sensor"
      method: 'GET'
      username: USERNAME
      password: PASSWORD
    .done (d) ->
      # console.log d
      for s in d
        if window.fn.playSensors[s.sensorId]?
           window.fn.playSensors[s.sensorId].position = s.position
           window.fn.playSensors[s.sensorId].description = s.description
           window.fn.playSensors[s.sensorId].coments = s.coments
        else
          window.fn.playSensors[s.sensorId] = s
          window.fn.playSensors[s.sensorId].name = s.description
          ons.notification.toast "Unknown sensor #{ s.sensorId }"

        pos = parsePos s.position
        marker = L.marker pos, { icon: window.fn.markerIcons[0] }
            .addTo window.fn.playMap
            .bindPopup """
              <p>Sensor: #{ window.fn.playSensors[s.sensorId].name }</p>
              <p>Group: #{ window.fn.playSensors[s.sensorId].group }
            """

  renderMap = () ->
    window.fn.playMap = L.map 'map-id'
          .setView CENTER, 12

    # L.tileLayer 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { }
    L.tileLayer 'http://{s}.tile.osm.org/{z}/{x}/{y}.png', {}
    .addTo window.fn.playMap

    # added for lat/lngs
    window.fn.playMap.on 'click', (e) ->
      ons.notification.alert "Pos: (#{ e.latlng.lat }, #{ e.latlng.lng })"
      console.log "Pos: (#{ e.latlng.lat }, #{ e.latlng.lng })"

    # for the sake of groups add them on the map
    polys = []
    for i, ll of latlngs
      polys[i] = L.polygon ll, color: 'olive', weight: 1
                  .addTo window.fn.playMap

    # put all sensors on map to determine area/group

    getLast24h()
    getSensors()

  renderMap()
  console.log "Darkgreen:", hsl2rgb(120, 1, 0.2)

# Darkgreen: rgb(0, 100, 0) hsl(120, 100%, 20%)
# Green: rgb(0, 128, 0) hsl(120, 100%, 25%)
# Forestgreen: rgb(34, 139, 34) hsl(120, 61%, 34%)
# Limegreen: rgb(50, 205, 50) hsl(120, 61%, 50%)
# Lime: rgb(0, 255, 0) hsl(120, 100%, 50%)
# Greenyellow: rgb(173, 255, 47) hsl(84, 100%, 59%)

# Orange: rgb(255, 165, 0) hsl(39, 100%, 50%)
# Orangered: rgb(255, 69, 0) hsl(16, 100%, 50%)
# Crimson: rgb(220, 20, 60) hsl(348, 83%, 47%)
# Darkred: rgb(139, 0, 0) hsl(0, 100%, 27%)
# Maroon: rgb(128, 0, 0) hsl(0, 100%, 25%)

# Darkmagenta: rgb(139, 0, 139) hsl(300, 100%, 27%)
# Purple: rgb(128, 0, 128) hsl(300, 100%, 25%)
# Indigo: rgb(75, 0, 130) hsl(275, 100%, 25%)
# Midnightblue: rgb(25, 25, 112) hsl(240, 64%, 27%)

hsl2rgb = (h, s, l) ->
  [r, g, b] = [0, 0, 0]

  if s is 0
    r = g = b = l; # achromatic
  else
    hue2rgb = (p, q, t) ->
      if t < 0 then t += 1
      if t > 1 then t -= 1
      if t < 1/6 then return p + (q - p) * 6 * t
      if t < 1/2  then return q
      if t < 2/3  then return p + (q - p) * (2/3 - t) * 6
      p


    q = if l < 0.5 then l * (1 + s) else l + s - l * s
    p = 2 * l - q
    r = hue2rgb(p, q, h + 1/3)
    g = hue2rgb(p, q, h)
    b = hue2rgb(p, q, h - 1/3)

  [Math.round(r * 255), Math.round(g * 255), Math.round(b * 255)]
